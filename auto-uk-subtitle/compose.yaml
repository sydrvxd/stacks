# Auto UK Subtitle Stack
# Automatic German to Ukrainian subtitle transcription and translation
#
# Dependencies:
# - ai-stack (Ollama, Whisper API, LiteLLM)
#
# Usage:
# 1. Start ai-stack first: docker compose -p ai-stack up -d
# 2. Then start this stack: docker compose -p auto-uk-subtitle up -d --build

services:
  # =============================================================================
  # AUTO UK SUBTITLE - Web Service
  # =============================================================================
  auto-uk-subtitle:
    build:
      context: https://github.com/sydrvxd/AutoUkSubtitle_WebService.git
      dockerfile: Dockerfile
    image: auto-uk-subtitle:latest
    container_name: auto-uk-subtitle
    restart: unless-stopped

    environment:
      # Application
      - APP_NAME=Auto UK Subtitle
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Media paths
      - MEDIA_PATH=/media
      - OUTPUT_PATH=/data/output
      - TEMP_PATH=/tmp/auto-uk-subtitle

      # Whisper API (from ai-stack)
      - WHISPER_API_URL=${WHISPER_API_URL:-http://whisper-api:8000}
      - WHISPER_MODEL=${WHISPER_MODEL:-large-v3}
      - WHISPER_LANGUAGE=${WHISPER_LANGUAGE:-de}

      # LLM API (direct to Ollama - has OpenAI-compatible endpoint)
      # Using gpt-oss:20b for best translation quality with 128K context
      - LLM_API_URL=${LLM_API_URL:-http://ollama:11434/v1}
      - OLLAMA_API_URL=${OLLAMA_API_URL:-http://ollama:11434}
      - LLM_API_KEY=${LLM_API_KEY:-ollama}
      - LLM_MODEL=${LLM_MODEL:-gpt-oss:20b}
      - LLM_TRANSLATION_MODEL=${LLM_TRANSLATION_MODEL:-gpt-oss:20b}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.2}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-16384}
      - LLM_REASONING_EFFORT=${LLM_REASONING_EFFORT:-medium}

      # Translation settings (optimized for gpt-oss:20b)
      # Chunk size is calculated dynamically based on model's 128K context limit.
      # This value is only used as fallback if model context cannot be determined.
      - TRANSLATION_CHUNK_SIZE=${TRANSLATION_CHUNK_SIZE:-15000}
      - TRANSLATION_MAX_RETRIES=${TRANSLATION_MAX_RETRIES:-7}
      - TRANSLATION_TIMEOUT=${TRANSLATION_TIMEOUT:-600}
      - TRANSLATION_CHUNK_OVERLAP=${TRANSLATION_CHUNK_OVERLAP:-2}

      # Self-healing / Circuit breaker settings
      - CIRCUIT_BREAKER_FAILURE_THRESHOLD=${CIRCUIT_BREAKER_FAILURE_THRESHOLD:-5}
      - CIRCUIT_BREAKER_RECOVERY_TIMEOUT=${CIRCUIT_BREAKER_RECOVERY_TIMEOUT:-60}
      - HEALTH_CHECK_INTERVAL=${HEALTH_CHECK_INTERVAL:-30}

      # Processing
      - MAX_PARALLEL_JOBS=${MAX_PARALLEL_JOBS:-2}
      - SPOT_CHECK_ENABLED=${SPOT_CHECK_ENABLED:-true}

      # Redis (optional, for job persistence)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}

    volumes:
      # Media files (your QNAP share) - read-write to save .uk.srt alongside videos
      - ${MEDIA_PATH:-/mnt/qnap/Multimedia}:/media:rw

      # Output directory (fallback for subtitle output)
      - subtitle-output:/data/output

      # Temp files
      - subtitle-temp:/tmp/auto-uk-subtitle

    ports:
      - "${WEB_PORT:-8085}:8080"

    networks:
      - ai-stack-network
      - default

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    mem_limit: 4g
    cpus: 4

  # =============================================================================
  # REDIS - Job Queue (optional but recommended)
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: auto-uk-subtitle-redis
    restart: unless-stopped

    command: redis-server --appendonly yes

    volumes:
      - redis-data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

    mem_limit: 256m

volumes:
  subtitle-output:
    name: auto-uk-subtitle-output
  subtitle-temp:
    name: auto-uk-subtitle-temp
  redis-data:
    name: auto-uk-subtitle-redis

networks:
  default:
    name: auto-uk-subtitle-network
  ai-stack-network:
    external: true
    name: ai-stack-network
