services:
  webtop:
    image: lscr.io/linuxserver/webtop:ubuntu-xfce
    container_name: webtop
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - PASSWORD=${WEBTOP_PASSWORD}
      - CUSTOM_USER=${WEBTOP_USERNAME}
      - NVIDIA_DRIVER_CAPABILITIES=all
      - NVIDIA_VISIBLE_DEVICES=all
      - DOCKER_MODS=linuxserver/mods:universal-package-install
      - INSTALL_PACKAGES=gstreamer1.0-tools|gstreamer1.0-plugins-good|gstreamer1.0-plugins-bad|gstreamer1.0-plugins-ugly|gstreamer1.0-libav|libva2|vainfo|nvidia-vaapi-driver
      - LIBVA_DRIVER_NAME=nvidia
      #- DRI_PRIME=1

    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all                        # Changed: expose all GPU capabilities
              capabilities: [gpu, compute, video, utility, graphics]

    devices:
      - /dev/dri:/dev/dri

    volumes:
      - chromium-config:/config
      - ./custom-cont-init.d:/custom-cont-init.d:ro

    security_opt:
      - seccomp:unconfined                      # Added: may help with D-Bus issues
      - apparmor:unconfined                     # Added: reduces permission errors
    #  - no-new-privileges:true

    # Stability & resources
    shm_size: "8gb"          # ðŸ‘ˆ this is the one that actually matters
    # SHM_SIZE env is unused by LSIO; safe to remove

    # Ensure /tmp has correct perms/owner (fixes "_X11-unix should be root")
    tmpfs:
      - /tmp:rw,nosuid,nodev,mode=1777

    # Resource limits for your hardware
    cpus: 10
    mem_limit: 24g

    ulimits:
      nofile: 262144
    pids_limit: 2048                            # Increased from 1024
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    ports:
      - "3000:3000"   # ðŸ‘ˆ add the web UI port (LSIO webtop default)
      - "3001:3001"   # keep if you use the secondary service

    restart: unless-stopped

volumes:
  chromium-config: